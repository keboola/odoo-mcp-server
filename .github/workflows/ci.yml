name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  PYTHON_VERSION: "3.12"

jobs:
  lint:
    name: Lint & Type Check
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Lint with ruff
        run: ruff check .

      - name: Type check with mypy
        run: mypy src/ --ignore-missing-imports

  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run unit tests
        run: pytest tests/unit -v --cov=src/ --cov-report=xml

      - name: Upload coverage
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage.xml
          fail_ci_if_error: false

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    # Only run on main branch or when explicitly requested
    if: github.ref == 'refs/heads/main' || contains(github.event.pull_request.labels.*.name, 'run-integration')

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run integration tests
        run: pytest tests/integration -v
        env:
          TEST_ODOO_URL: ${{ secrets.TEST_ODOO_URL }}
          TEST_ODOO_DB: ${{ secrets.TEST_ODOO_DB }}
          TEST_ODOO_API_KEY: ${{ secrets.TEST_ODOO_API_KEY }}
          TEST_MCP_SERVER_URL: ${{ secrets.TEST_MCP_SERVER_URL }}
          TEST_AUTH_SERVER_URL: ${{ secrets.TEST_AUTH_SERVER_URL }}

  # NOTE: E2E tests use Claude Code Chrome integration and require
  # interactive browser access. They cannot run in headless CI.
  # Run manually with: ./scripts/run_e2e_tests.sh
  # See tests/e2e/README.md for details.

  security:
    name: Security Scan
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
          pip install bandit pip-audit safety

      - name: Run Bandit (Python security linter)
        run: bandit -r src/ -ll -ii -x tests/

      - name: Run pip-audit (dependency vulnerabilities)
        run: pip-audit --strict --progress-spinner=off
        continue-on-error: true

      - name: Run Safety check (known vulnerabilities)
        run: safety check --full-report
        continue-on-error: true

  build:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: [lint, unit-tests, security]

    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./docker/Dockerfile
          push: false
          tags: keboola/odoo-mcp-server:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: [build, integration-tests]
    if: github.ref == 'refs/heads/main'
    environment: staging

    steps:
      - uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for GCR
        run: gcloud auth configure-docker

      - name: Build and push to GCR
        run: |
          docker build -t gcr.io/${{ secrets.GCP_PROJECT_ID }}/odoo-mcp-server:${{ github.sha }} -f docker/Dockerfile .
          docker push gcr.io/${{ secrets.GCP_PROJECT_ID }}/odoo-mcp-server:${{ github.sha }}

      - name: Deploy to Cloud Run (Staging)
        run: |
          gcloud run deploy odoo-mcp-server-staging \
            --image gcr.io/${{ secrets.GCP_PROJECT_ID }}/odoo-mcp-server:${{ github.sha }} \
            --region europe-west1 \
            --platform managed \
            --allow-unauthenticated \
            --set-env-vars "ODOO_URL=${{ secrets.STAGING_ODOO_URL }}" \
            --set-env-vars "ODOO_DB=${{ secrets.STAGING_ODOO_DB }}" \
            --set-secrets "ODOO_API_KEY=odoo-api-key:latest" \
            --set-secrets "OAUTH_CLIENT_SECRET=oauth-client-secret:latest"
